<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nc7.mapp.dao.FilmDao">

  <!-- 영화 정보 조회 -->
  <select id="findByNo" parameterType="int" resultMap="filmMap">
    SELECT
      f.films_no,
      f.title,
      f.films_image_url,
      f.grade_no,
      f.descriptions,
      f.running_time,
      f.released_date,
      g.genres_no,
      g.name AS genre_name
    FROM
      films f INNER JOIN films_genres fg ON f.films_no = fg.films_no
               INNER JOIN genres g ON fg.genres_no = g.genres_no
    WHERE
      f.films_no = #{filmNo}
  </select>
  
  <!-- 영화 목록 조회 -->
  <select id="findAll" resultMap="filmMap">
    SELECT
      f.films_no,
      f.title,
      f.films_image_url,
      f.grade_no,
      f.descriptions,
      f.running_time,
      f.released_date,
      g.genres_no,
      g.name AS genre_name
    FROM
      films f INNER JOIN films_genres fg ON f.films_no = fg.films_no
               INNER JOIN genres g ON fg.genres_no = g.genres_no
    ORDER BY
      f.films_no DESC
  </select>
  
  <!-- 영화 정보 삽입 -->
  <insert id="insert" parameterType="film">
    INSERT INTO films(title, films_image_url, grade_no, descriptions, running_time, released_date)
    VALUES(#{title}, #{filmsImageUrl}, #{grade.gradeNo}, #{descriptions}, #{runningTime}, #{releasedDate})
  </insert>
  
  <!-- 영화 정보 수정 -->
  <update id="update" parameterType="film">
    UPDATE films SET
      title = #{title},
      films_image_url = #{filmsImageUrl},
      grade_no = #{grade.gradeNo},
      descriptions = #{descriptions},
      running_time = #{runningTime},
      released_date = #{releasedDate}
    WHERE films_no = #{filmsNo}
  </update>
  
  <!-- 영화 정보 삭제 -->
  <delete id="delete" parameterType="int">
    DELETE FROM films
    WHERE films_no = #{filmNo}
  </delete>
  
  <!-- resultMap 정의 -->
  <resultMap type="film" id="filmMap">
    <id column="films_no" property="filmsNo" />
    <result column="title" property="title" />
    <result column="films_image_url" property="filmsImageUrl" />
    <result column="descriptions" property="descriptions" />
    <result column="running_time" property="runningTime" />
    <result column="released_date" property="releasedDate" />
    <association property="grade" javaType="grade">
      <id column="grade_no" property="gradeNo" />
      <result column="name" property="name" />
    </association>
    <collection property="genres" javaType="java.util.List" ofType="java.lang.String">
      <id column="genres_no" property="genresNo" />
      <result column="genre_name" property="name" />
    </collection>
  </resultMap>
  
  <!-- genres에 대한 resultMap 정의 -->
  <resultMap type="java.lang.String" id="genreMap">
    <id column="genres_no" property="genresNo" />
    <result column="genre_name" property="name" />
  </resultMap>
</mapper>